<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å¹å¥æ¥½ã‚¹ãƒ†ãƒ¼ã‚¸é…ç½®</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body{
  margin:0;
  display:flex;
  font-family:sans-serif;
  background:#f0f2f5;
}

/* ===== ãƒ‘ãƒ¬ãƒƒãƒˆ ===== */
#palette{
  width:220px;
  background:#222;
  color:white;
  padding:10px;
}

.paletteItem{
  background:#444;
  margin:8px 0;
  padding:12px;
  text-align:center;
  border-radius:6px;
  cursor:grab;
}

.paletteItem:active{
  cursor:grabbing;
}

#stageArea{
  flex:1;
  padding:10px;
}

canvas{
  background:white;
  border:2px solid #999;
}
</style>
</head>

<body>

<div id="palette">
  <h3>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é…ç½®</h3>

  <div class="paletteItem" draggable="true" data-type="chair">ğŸª‘ æ¤…å­</div>
  <div class="paletteItem" draggable="true" data-type="stand">ğŸ¼ è­œé¢å°</div>
  <div class="paletteItem" draggable="true" data-type="trumpet">ğŸº ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ</div>
  <div class="paletteItem" draggable="true" data-type="sax">ğŸ· ã‚µãƒƒã‚¯ã‚¹</div>
</div>

<div id="stageArea">
  <canvas id="c" width="1000" height="650"></canvas>
</div>

<script>
const canvas = new fabric.Canvas('c');

/* =========================
   HTML â†’ Canvas Drag & Drop
========================= */

let dragType=null;

document.querySelectorAll(".paletteItem").forEach(el=>{
  el.addEventListener("dragstart",e=>{
    dragType = el.dataset.type;
  });
});

canvas.upperCanvasEl.addEventListener("dragover",e=>{
  e.preventDefault();
});

canvas.upperCanvasEl.addEventListener("drop",e=>{
  e.preventDefault();

  const rect = canvas.upperCanvasEl.getBoundingClientRect();

  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  createObject(dragType,x,y);
});

/* =========================
   ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
========================= */

function createObject(type,x,y){

  if(type==="chair"){
    const chair = new fabric.Rect({
      left:x,
      top:y,
      width:35,
      height:35,
      fill:"#8b5a2b",
      rx:5,
      ry:5
    });
    chair.typeTag="chair";
    chair.occupied=false;
    canvas.add(chair);
  }

  if(type==="stand"){
    const stand = new fabric.Group([
      new fabric.Rect({width:30,height:20,fill:"#333",top:-10}),
      new fabric.Rect({width:4,height:40,fill:"#333",top:10})
    ],{left:x,top:y});
    stand.typeTag="stand";
    canvas.add(stand);
  }

  if(type==="trumpet" || type==="sax"){
    const icon = type==="trumpet"?"ğŸº":"ğŸ·";

    const inst = new fabric.Text(icon,{
      left:x,
      top:y,
      fontSize:30
    });

    inst.typeTag="instrument";
    inst.linkedChair=null;
    canvas.add(inst);
  }
}

/* =========================
   æ¤…å­ãƒªãƒ³ã‚¯åˆ¤å®š
========================= */

canvas.on("object:moving",function(e){

  const obj=e.target;

  if(obj.typeTag!=="instrument") return;

  let linked=null;

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair"){

      const dx=o.left-obj.left;
      const dy=o.top-obj.top;
      const dist=Math.sqrt(dx*dx+dy*dy);

      if(dist<40){
        linked=o;
      }
    }
  });

  /* å…¨æ¤…å­ãƒªã‚»ãƒƒãƒˆ */
  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair"){
      o.set("fill","#8b5a2b");
      o.occupied=false;
    }
  });

  /* ãƒªãƒ³ã‚¯æˆç«‹ */
  if(linked){
    linked.set("fill","#2ecc71");
    linked.occupied=true;
    obj.linkedChair=linked;
  }else{
    obj.linkedChair=null;
  }

  canvas.renderAll();
});

/* =========================
   Deleteã‚­ãƒ¼å‰Šé™¤
========================= */

document.addEventListener("keydown",e=>{
  if(e.key==="Delete"){
    const obj=canvas.getActiveObject();
    if(obj) canvas.remove(obj);
  }
});
</script>

</body>
</html>
