<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>èˆå°é…ç½®ã‚¨ãƒ‡ã‚£ã‚¿</title>

<style>
body{margin:0;display:flex;height:100vh;font-family:sans-serif;}
#palette{width:220px;background:#eee;padding:10px;overflow:auto;}
.paletteItem{background:#fff;border:1px solid #aaa;padding:8px;margin:5px 0;cursor:grab;}
canvas{flex:1;background:#f8f8f8;touch-action:none;}
/* ===== ã‚¹ãƒãƒ›UI ===== */
#mobileBar{
 position:fixed;
 bottom:0;
 left:0;
 right:0;
 height:70px;
 background:#ffffff;
 border-top:2px solid #ccc;
 display:none;
 justify-content:space-around;
 align-items:center;
 z-index:10;
}

.mobileBtn{
 font-size:24px;
 background:#f0f0f0;
 border-radius:12px;
 padding:10px 14px;
}

@media (max-width:800px){
 #palette{display:none;}
 #mobileBar{display:flex;}
 canvas{
   width:100vw !important;
   height:calc(100vh - 70px) !important;
 }
}
</style>
</head>
  <div class="mobileBtn" onclick="setAdd('chair')">ğŸª‘</div>
  <div class="mobileBtn" onclick="setAdd('stand')">ğŸ¼</div>
  <div class="mobileBtn" onclick="setAdd('step')">â¬›</div>
  <div class="mobileBtn" onclick="setAdd('light')">ğŸ’¡</div>
  <div class="mobileBtn" onclick="addInstrumentMobile()">ğŸº+</div>
</div>
<body>

<div id="mobileBar">

<div id="palette">
<h3>ãƒ‘ãƒ¬ãƒƒãƒˆ</h3>

<div class="paletteItem" draggable="true" data-type="chair">æ¤…å­</div>
<div class="paletteItem" draggable="true" data-type="stand">è­œé¢å°</div>
<div class="paletteItem" draggable="true" data-type="step">æ®µ</div>
<div class="paletteItem" draggable="true" data-type="light">ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆ</div>

<hr>

<input id="instName" placeholder="æ¥½å™¨å">
<button onclick="addInstrument()">æ¥½å™¨è¿½åŠ </button>

</div>

<canvas id="canvas"></canvas>

<script>
function setAdd(type,name=""){
 addMode = type;
 addName = name;
}
const isTouchDevice =
  'ontouchstart' in window ||
  navigator.maxTouchPoints > 0;
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

function resize(){

 const ratio = window.devicePixelRatio || 1;

 if(window.innerWidth < 800){

   canvas.style.width = "100vw";
   canvas.style.height = "calc(100vh - 70px)";

   canvas.width = window.innerWidth * ratio;
   canvas.height = (window.innerHeight - 70) * ratio;

 }else{

   canvas.style.width = "";
   canvas.style.height = "";

   canvas.width = (window.innerWidth - 220) * ratio;
   canvas.height = window.innerHeight * ratio;
 }

 ctx.setTransform(ratio,0,0,ratio,0,0);
}
resize();
window.onresize=resize;

let objects=[];
let selected=null;
let dragging=false;
let resizing=false;
let offsetX=0,offsetY=0;
let addMode = null;
let addName = "";
/* ---------- ä½œæˆ ---------- */

function createObject(type,x,y,name=""){
 return{
  id:Date.now()+Math.random(),
  type,x,y,
  w:140,
  h:70,
  radius:80,
  name,
  linkedChairId:null
 };
}

/* ---------- æ¥½å™¨è¿½åŠ  ---------- */

function addInstrument(){
 const name=document.getElementById("instName").value.trim();
 if(!name)return;

 const div=document.createElement("div");
 div.className="paletteItem";
 div.textContent=name;
 div.dataset.type="instrument";
 div.dataset.name=name;

 if(isTouchDevice){

   div.onclick=()=>{
     addMode="instrument";
     addName=name;
     alert("é…ç½®ã—ãŸã„å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„");
   };

 }else{

   div.draggable=true;
   div.addEventListener("dragstart",e=>{
     e.dataTransfer.setData("type","instrument");
     e.dataTransfer.setData("name",name);
   });

 }

 document.getElementById("palette").appendChild(div);
}

function addInstrumentMobile(){

 const name = prompt("æ¥½å™¨åã‚’å…¥åŠ›");
 if(!name) return;

 const div=document.createElement("div");
 div.className="paletteItem";
 div.textContent=name;
 div.dataset.type="instrument";
 div.dataset.name=name;

 // â˜…ã‚¹ãƒãƒ›ç”¨ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
 div.onclick=()=>{
   addMode="instrument";
   addName=name;
 };

 document.getElementById("palette").appendChild(div);

 // å³é…ç½®ãƒ¢ãƒ¼ãƒ‰
 addMode="instrument";
 addName=name;
}
 // ãã®ã¾ã¾é…ç½®ãƒ¢ãƒ¼ãƒ‰ã¸
 addMode="instrument";
 addName=name;
}
/* ---------- DnD ---------- */

document.querySelectorAll(".paletteItem").forEach(el=>{

  if(isTouchDevice){

    // ã‚¹ãƒãƒ›ï¼šã‚¿ãƒƒãƒ—è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
    el.onclick=()=>{
      addMode = el.dataset.type;
      addName = el.dataset.name || "";
      alert("é…ç½®ã—ãŸã„å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„");
    };

  }else{

    // PCï¼šå¾“æ¥DnD
    el.addEventListener("dragstart",e=>{
      e.dataTransfer.setData("type",el.dataset.type);
      e.dataTransfer.setData("name",el.dataset.name||"");
    });

  }
});

canvas.addEventListener("dragover",e=>e.preventDefault());

canvas.addEventListener("drop",e=>{
 const rect=canvas.getBoundingClientRect();
 const type=e.dataTransfer.getData("type");
 const name=e.dataTransfer.getData("name");

 objects.push(createObject(
   type,
   e.clientX-rect.left,
   e.clientY-rect.top,
   name
 ));
});

/* ---------- å…¥åŠ› ---------- */

canvas.onpointerdown=e=>{

 const r=canvas.getBoundingClientRect();
 const x=e.clientX-r.left;
 const y=e.clientY-r.top;

 // --- è¿½åŠ ãƒ¢ãƒ¼ãƒ‰é…ç½® ---
 if(addMode){
   objects.push(createObject(addMode,x,y,addName));
   addMode=null;
   return;
 }

 selected=null;

 for(let i=objects.length-1;i>=0;i--){
   const o=objects[i];

   // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«
   if(o.type==="step"){
     if(Math.abs(x-(o.x+o.w/2))<10 &&
        Math.abs(y-(o.y+o.h/2))<10){
        selected=o;
        resizing=true;
        return;
     }
   }

   if(o.type==="light"){
     if(Math.hypot(x-o.x,y-o.y)<o.radius+10 &&
        Math.hypot(x-o.x,y-o.y)>o.radius-10){
        selected=o;
        resizing=true;
        return;
     }
   }

   if(Math.abs(o.x-x)<40 && Math.abs(o.y-y)<40){
     selected=o;
     dragging=true;
     offsetX=x-o.x;
     offsetY=y-o.y;
     return;
   }
 }
};

canvas.onpointermove=e=>{
 if(!selected)return;

 const r=canvas.getBoundingClientRect();
 const x=e.clientX-r.left;
 const y=e.clientY-r.top;

 if(dragging){

   const newX = x - offsetX;
   const newY = y - offsetY;

   const dx = newX - selected.x;
   const dy = newY - selected.y;

   selected.x = newX;
   selected.y = newY;

   /* â˜…è¿½åŠ ï¼šæ¤…å­ç§»å‹•æ™‚ã«ãƒªãƒ³ã‚¯æ¥½å™¨ã‚‚å‹•ã‹ã™ */
   if(selected.type === "chair"){

     objects.forEach(o=>{
       if(
         o.type === "instrument" &&
         o.linkedChairId === selected.id
       ){
         o.x += dx;
         o.y += dy;
       }
     });

   }
}

 if(resizing){
   if(selected.type==="step"){
     selected.w=Math.abs(x-selected.x)*2;
     selected.h=Math.abs(y-selected.y)*2;
   }
   if(selected.type==="light"){
     selected.radius=Math.hypot(x-selected.x,y-selected.y);
   }
 }
};

canvas.onpointerup=()=>{
 dragging=false;
 resizing=false;
};

/* ---------- ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‰Šé™¤ ---------- */

canvas.ondblclick=e=>{
 const r=canvas.getBoundingClientRect();
 const x=e.clientX-r.left;
 const y=e.clientY-r.top;

 objects=objects.filter(o=>{
   return !(Math.abs(o.x-x)<40 && Math.abs(o.y-y)<40);
 });
};

/* ---------- è‡ªå‹•ãƒªãƒ³ã‚¯ ---------- */

function autoLink(){
 const chairs=objects.filter(o=>o.type==="chair");
 const insts=objects.filter(o=>o.type==="instrument");

 insts.forEach(inst=>{
   inst.linkedChairId=null;
   chairs.forEach(ch=>{
     if(Math.hypot(inst.x-ch.x,inst.y-ch.y)<40){
       inst.linkedChairId=ch.id;
     }
   });
 });
}

/* ---------- æç”» ---------- */

function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 autoLink();

 ctx.strokeStyle="#000";
 ctx.fillStyle="#000";
 ctx.font="12px sans-serif";
 ctx.textAlign="center";

 objects.forEach(o=>{

   // æ®µ
   if(o.type==="step"){
     ctx.strokeRect(o.x-o.w/2,o.y-o.h/2,o.w,o.h);

     // ãƒãƒ³ãƒ‰ãƒ«
     ctx.fillRect(o.x+o.w/2-5,o.y+o.h/2-5,10,10);
   }

   // æ¤…å­
   if(o.type==="chair"){
     ctx.beginPath();
     ctx.arc(o.x,o.y,30,0,Math.PI*2);
     ctx.stroke();

     const inst=objects.find(i=>i.linkedChairId===o.id);
     if(inst){
       ctx.fillText(inst.name,o.x,o.y+4);
     }
   }

   // è­œé¢å°
   if(o.type==="stand"){
     ctx.beginPath();
     ctx.moveTo(o.x,o.y-20);
     ctx.lineTo(o.x,o.y+20);
     ctx.moveTo(o.x-20,o.y-20);
     ctx.lineTo(o.x+20,o.y-20);
     ctx.stroke();
   }

   // æ¥½å™¨ï¼ˆãƒªãƒ³ã‚¯ä¸­éè¡¨ç¤ºï¼‰
   if(o.type==="instrument"){
     if(o.linkedChairId)return;
     ctx.strokeRect(o.x-30,o.y-30,60,60);
     ctx.fillText(o.name,o.x,o.y+4);
   }

   // ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆ
   if(o.type==="light"){
     ctx.beginPath();
     ctx.fillStyle="rgba(255,255,0,0.3)";
     ctx.arc(o.x,o.y,o.radius,0,Math.PI*2);
     ctx.fill();

     ctx.strokeStyle="#000";
     ctx.beginPath();
     ctx.arc(o.x,o.y,o.radius,0,Math.PI*2);
     ctx.stroke();

     ctx.fillStyle="#000";
   }

 });

 requestAnimationFrame(draw);
}
draw();

let pinchStartDist = null;

canvas.addEventListener("pointermove", e=>{
  if(e.pointerType !== "touch") return;
});

 canvas.addEventListener("touchmove", e=>{

  if(e.touches.length===2 && selected){

    const dx =
      e.touches[0].clientX -
      e.touches[1].clientX;

    const dy =
      e.touches[0].clientY -
      e.touches[1].clientY;

    const dist = Math.hypot(dx,dy);

    if(!pinchStartDist){
      pinchStartDist = dist;
      return;
    }

    const scale = dist / pinchStartDist;

    if(selected.type==="step"){
      selected.w *= scale;
      selected.h *= scale;
    }

    if(selected.type==="light"){
      selected.radius *= scale;
    }

    pinchStartDist = dist;
  }

},{passive:false});

canvas.addEventListener("touchend",()=>{
  pinchStartDist=null;
});

let lastTap = 0;

canvas.addEventListener("pointerdown",e=>{

  const now = Date.now();
  if(now - lastTap < 300){

    const r=canvas.getBoundingClientRect();
    const x=e.clientX-r.left;
    const y=e.clientY-r.top;

    objects = objects.filter(o=>
      !(Math.abs(o.x-x)<40 && Math.abs(o.y-y)<40)
    );
  }
  lastTap = now;
});
</script>
</body>
</html>
