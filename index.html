<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å¹å¥æ¥½ã‚¹ãƒ†ãƒ¼ã‚¸é…ç½®</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body{
  margin:0;
  display:flex;
  font-family:sans-serif;
  background:#f0f2f5;
}

/* ===== ãƒ‘ãƒ¬ãƒƒãƒˆ ===== */
#palette{
  width:240px;
  background:#222;
  color:white;
  padding:10px;
}

.paletteItem{
  background:#444;
  margin:8px 0;
  padding:12px;
  text-align:center;
  border-radius:6px;
  cursor:grab;
}

#stageArea{
  flex:1;
  padding:10px;
}

canvas{
  background:white;
  border:2px solid #999;
}

input,button{
  width:100%;
  margin-top:6px;
  padding:6px;
}
</style>
</head>

<body>

<div id="palette">
  <h3>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é…ç½®</h3>

  <div id="items"></div>

  <hr>

  <input id="instName" placeholder="æ¥½å™¨åã‚’å…¥åŠ›">
  <button onclick="addNewInstrument()">æ¥½å™¨ã‚’è¿½åŠ </button>
</div>

<div id="stageArea">
  <canvas id="c" width="1000" height="650"></canvas>
</div>

<script>
const canvas = new fabric.Canvas('c');

const itemsDiv=document.getElementById("items");

/* =====================
   ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆ
===================== */

function createPaletteItem(name,type,icon){
  const div=document.createElement("div");
  div.className="paletteItem";
  div.textContent=icon+" "+name;
  div.draggable=true;

  div.addEventListener("dragstart",e=>{
    e.dataTransfer.setData("type",type);
    e.dataTransfer.setData("icon",icon);
    e.dataTransfer.setData("name",name);
  });

  itemsDiv.appendChild(div);
}

/* åˆæœŸã‚¢ã‚¤ãƒ†ãƒ  */
createPaletteItem("æ¤…å­","chair","ğŸª‘");
createPaletteItem("è­œé¢å°","stand","ğŸ¼");
createPaletteItem("ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ","instrument","ğŸº");
createPaletteItem("ã‚µãƒƒã‚¯ã‚¹","instrument","ğŸ·");

/* =====================
   æ¥½å™¨è¿½åŠ æ©Ÿèƒ½
===================== */

function addNewInstrument(){
  const name=document.getElementById("instName").value.trim();
  if(!name) return;

  createPaletteItem(name,"instrument","ğŸµ");
  document.getElementById("instName").value="";
}

/* =====================
   Dropå‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
===================== */

const canvasContainer=canvas.upperCanvasEl;

canvasContainer.addEventListener("dragover",e=>{
  e.preventDefault();
});

canvasContainer.addEventListener("drop",e=>{
  e.preventDefault();

  const type=e.dataTransfer.getData("type");
  const icon=e.dataTransfer.getData("icon");

  const pointer=canvas.getPointer(e);

  createObject(type,icon,pointer.x,pointer.y);
});

/* =====================
   ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
===================== */

function createObject(type,icon,x,y){

  if(type==="chair"){
    const chair=new fabric.Rect({
      left:x,
      top:y,
      width:35,
      height:35,
      fill:"#8b5a2b",
      rx:5,
      ry:5
    });
    chair.typeTag="chair";
    canvas.add(chair);
  }

  if(type==="stand"){
    const stand=new fabric.Group([
      new fabric.Rect({width:30,height:20,fill:"#333",top:-10}),
      new fabric.Rect({width:4,height:40,fill:"#333",top:10})
    ],{left:x,top:y});
    stand.typeTag="stand";
    canvas.add(stand);
  }

  if(type==="instrument"){
    const inst=new fabric.Text(icon,{
      left:x,
      top:y,
      fontSize:30
    });
    inst.typeTag="instrument";
    inst.linkedChair=null;
    canvas.add(inst);
  }
}

/* =====================
   æ¤…å­ãƒªãƒ³ã‚¯åˆ¤å®š
===================== */

canvas.on("object:moving",e=>{

  const obj=e.target;
  if(obj.typeTag!=="instrument") return;

  let linked=null;

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair"){
      const dx=o.left-obj.left;
      const dy=o.top-obj.top;
      const dist=Math.sqrt(dx*dx+dy*dy);

      if(dist<40) linked=o;
    }
  });

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair"){
      o.set("fill","#8b5a2b");
    }
  });

  if(linked){
    linked.set("fill","#2ecc71");
    obj.linkedChair=linked;
  }else{
    obj.linkedChair=null;
  }

  canvas.renderAll();
});

/* =====================
   Deleteå‰Šé™¤
===================== */

document.addEventListener("keydown",e=>{
  if(e.key==="Delete"){
    const obj=canvas.getActiveObject();
    if(obj) canvas.remove(obj);
  }
});
</script>

</body>
</html>
