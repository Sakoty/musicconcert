<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>吹奏楽ステージ配置</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body{
  margin:0;
  display:flex;
  font-family:sans-serif;
}

#palette{
  width:220px;
  background:#222;
  color:white;
  padding:10px;
}

.item{
  background:#444;
  margin:8px 0;
  padding:10px;
  text-align:center;
  border-radius:6px;
  cursor:pointer;
}

.selected{
  background:#2ecc71;
}

canvas{
  background:white;
  border:2px solid #888;
}
</style>
</head>

<body>

<div id="palette">
<h3>配置する物</h3>

<div class="item" data-type="chair">椅子 ○</div>
<div class="item" data-type="stand">譜面台 T</div>
<div class="item" data-type="step">段差</div>
<div class="item" data-type="instrument">楽器</div>

<input id="instName" placeholder="楽器名">
</div>

<canvas id="c" width="1000" height="650"></canvas>

<script>
const canvas=new fabric.Canvas('c');

let selectedType=null;

/* =====================
   パレット選択
===================== */

document.querySelectorAll(".item").forEach(el=>{
  el.onclick=()=>{
    document.querySelectorAll(".item")
      .forEach(i=>i.classList.remove("selected"));

    el.classList.add("selected");
    selectedType=el.dataset.type;
  };
});

/* =====================
   キャンバスクリック配置
===================== */

canvas.on("mouse:down",function(opt){

  if(!selectedType) return;

  const pointer=canvas.getPointer(opt.e);

  createObject(selectedType,pointer.x,pointer.y);
});

/* =====================
   椅子（○）
===================== */

function createChair(x,y){

  const circle=new fabric.Circle({
    radius:20,
    fill:"#fff",
    stroke:"#000",
    strokeWidth:2,
    originX:"center",
    originY:"center"
  });

  const label=new fabric.Text("",{
    fontSize:12,
    originX:"center",
    originY:"center"
  });

  const group=new fabric.Group([circle,label],{
    left:x,
    top:y
  });

  group.typeTag="chair";
  group.label=label;

  canvas.add(group);
}

/* =====================
   譜面台（T字）
===================== */

function createStand(x,y){

  const top=new fabric.Rect({
    width:30,height:6,fill:"#000",top:-12
  });

  const pole=new fabric.Rect({
    width:4,height:30,fill:"#000"
  });

  const stand=new fabric.Group([top,pole],{
    left:x,
    top:y
  });

  stand.typeTag="stand";
  canvas.add(stand);
}

/* =====================
   段差
===================== */

let stepNo=1;

function createStep(x,y){

  const top=new fabric.Rect({
    width:160,height:60,fill:"#d0d0d0"
  });

  const side=new fabric.Rect({
    width:160,height:15,fill:"#999",top:60
  });

  const text=new fabric.Text("STEP "+stepNo,{
    fontSize:14,left:40,top:20
  });

  const g=new fabric.Group([top,side,text],{
    left:x,
    top:y
  });

  g.typeTag="step";
  stepNo++;

  canvas.add(g);
  g.sendToBack();
}

/* =====================
   楽器
===================== */

function createInstrument(x,y){

  const name=
    document.getElementById("instName").value || "Inst";

  const text=new fabric.Text(name,{
    fontSize:16,
    left:x,
    top:y
  });

  text.typeTag="instrument";
  text.instrumentName=name;

  canvas.add(text);
}

/* =====================
   分岐
===================== */

function createObject(type,x,y){

  if(type==="chair") createChair(x,y);
  if(type==="stand") createStand(x,y);
  if(type==="step") createStep(x,y);
  if(type==="instrument") createInstrument(x,y);
}

/* =====================
   椅子リンク
===================== */

canvas.on("object:moving",e=>{

  const obj=e.target;
  if(obj.typeTag!=="instrument") return;

  let linked=null;

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair"){
      const dx=o.left-obj.left;
      const dy=o.top-obj.top;
      if(Math.sqrt(dx*dx+dy*dy)<35)
        linked=o;
    }
  });

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair")
      o.label.text="";
  });

  if(linked){
    linked.label.text=obj.instrumentName;
  }

  canvas.requestRenderAll();
});

/* =====================
   Delete削除
===================== */

document.addEventListener("keydown",e=>{
  if(e.key==="Delete"){
    const obj=canvas.getActiveObject();
    if(obj) canvas.remove(obj);
  }
});
</script>

</body>
</html>
