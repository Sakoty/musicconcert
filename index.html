<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>舞台配置エディタ</title>

<style>
body{margin:0;display:flex;height:100vh;font-family:sans-serif;}
#palette{width:220px;background:#eee;padding:10px;overflow:auto;}
.paletteItem{background:#fff;border:1px solid #aaa;padding:8px;margin:5px 0;cursor:grab;}
canvas{flex:1;background:#f8f8f8;touch-action:none;}
</style>
</head>

<body>

<div id="palette">
<h3>パレット</h3>

<div class="paletteItem" draggable="true" data-type="chair">椅子</div>
<div class="paletteItem" draggable="true" data-type="stand">譜面台</div>
<div class="paletteItem" draggable="true" data-type="step">段</div>
<div class="paletteItem" draggable="true" data-type="light">スポットライト</div>

<hr>

<input id="instName" placeholder="楽器名">
<button onclick="addInstrument()">楽器追加</button>

</div>

<canvas id="canvas"></canvas>

<script>
const isTouchDevice =
  'ontouchstart' in window ||
  navigator.maxTouchPoints > 0;
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

function resize(){
 canvas.width=window.innerWidth-220;
 canvas.height=window.innerHeight;
}
resize();
window.onresize=resize;

let objects=[];
let selected=null;
let dragging=false;
let resizing=false;
let offsetX=0,offsetY=0;
let addMode = null;
let addName = "";
/* ---------- 作成 ---------- */

function createObject(type,x,y,name=""){
 return{
  id:Date.now()+Math.random(),
  type,x,y,
  w:140,
  h:70,
  radius:80,
  name,
  linkedChairId:null
 };
}

/* ---------- 楽器追加 ---------- */

function addInstrument(){
 const name=document.getElementById("instName").value.trim();
 if(!name)return;

 const div=document.createElement("div");
 div.className="paletteItem";
 div.textContent=name;
 div.draggable=true;
 div.dataset.type="instrument";
 div.dataset.name=name;

 div.addEventListener("dragstart",e=>{
   e.dataTransfer.setData("type","instrument");
   e.dataTransfer.setData("name",name);
 });

 document.getElementById("palette").appendChild(div);
}

/* ---------- DnD ---------- */

document.querySelectorAll(".paletteItem").forEach(el=>{

  if(isTouchDevice){

    // スマホ：タップ追加モード
    el.onclick=()=>{
      addMode = el.dataset.type;
      addName = el.dataset.name || "";
      alert("配置したい場所をタップしてください");
    };

  }else{

    // PC：従来DnD
    el.addEventListener("dragstart",e=>{
      e.dataTransfer.setData("type",el.dataset.type);
      e.dataTransfer.setData("name",el.dataset.name||"");
    });

  }
});

canvas.addEventListener("dragover",e=>e.preventDefault());

canvas.addEventListener("drop",e=>{
 const rect=canvas.getBoundingClientRect();
 const type=e.dataTransfer.getData("type");
 const name=e.dataTransfer.getData("name");

 objects.push(createObject(
   type,
   e.clientX-rect.left,
   e.clientY-rect.top,
   name
 ));
});

/* ---------- 入力 ---------- */

canvas.onpointerdown=e=>{
 // --- 追加モード配置 ---
if(addMode){
  objects.push(createObject(addMode,x,y,addName));
  addMode=null;
  return;
}
 const r=canvas.getBoundingClientRect();
 const x=e.clientX-r.left;
 const y=e.clientY-r.top;

 selected=null;

 for(let i=objects.length-1;i>=0;i--){
   const o=objects[i];

   // リサイズハンドル
   if(o.type==="step"){
     if(Math.abs(x-(o.x+o.w/2))<10 &&
        Math.abs(y-(o.y+o.h/2))<10){
        selected=o;
        resizing=true;
        return;
     }
   }

   if(o.type==="light"){
     if(Math.hypot(x-o.x,y-o.y)<o.radius+10 &&
        Math.hypot(x-o.x,y-o.y)>o.radius-10){
        selected=o;
        resizing=true;
        return;
     }
   }

   if(Math.abs(o.x-x)<40 && Math.abs(o.y-y)<40){
     selected=o;
     dragging=true;
     offsetX=x-o.x;
     offsetY=y-o.y;
     return;
   }
 }
};

canvas.onpointermove=e=>{
 if(!selected)return;

 const r=canvas.getBoundingClientRect();
 const x=e.clientX-r.left;
 const y=e.clientY-r.top;

 if(dragging){

   const newX = x - offsetX;
   const newY = y - offsetY;

   const dx = newX - selected.x;
   const dy = newY - selected.y;

   selected.x = newX;
   selected.y = newY;

   /* ★追加：椅子移動時にリンク楽器も動かす */
   if(selected.type === "chair"){

     objects.forEach(o=>{
       if(
         o.type === "instrument" &&
         o.linkedChairId === selected.id
       ){
         o.x += dx;
         o.y += dy;
       }
     });

   }
}

 if(resizing){
   if(selected.type==="step"){
     selected.w=Math.abs(x-selected.x)*2;
     selected.h=Math.abs(y-selected.y)*2;
   }
   if(selected.type==="light"){
     selected.radius=Math.hypot(x-selected.x,y-selected.y);
   }
 }
};

canvas.onpointerup=()=>{
 dragging=false;
 resizing=false;
};

/* ---------- ダブルクリック削除 ---------- */

canvas.ondblclick=e=>{
 const r=canvas.getBoundingClientRect();
 const x=e.clientX-r.left;
 const y=e.clientY-r.top;

 objects=objects.filter(o=>{
   return !(Math.abs(o.x-x)<40 && Math.abs(o.y-y)<40);
 });
};

/* ---------- 自動リンク ---------- */

function autoLink(){
 const chairs=objects.filter(o=>o.type==="chair");
 const insts=objects.filter(o=>o.type==="instrument");

 insts.forEach(inst=>{
   inst.linkedChairId=null;
   chairs.forEach(ch=>{
     if(Math.hypot(inst.x-ch.x,inst.y-ch.y)<40){
       inst.linkedChairId=ch.id;
     }
   });
 });
}

/* ---------- 描画 ---------- */

function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 autoLink();

 ctx.strokeStyle="#000";
 ctx.fillStyle="#000";
 ctx.font="12px sans-serif";
 ctx.textAlign="center";

 objects.forEach(o=>{

   // 段
   if(o.type==="step"){
     ctx.strokeRect(o.x-o.w/2,o.y-o.h/2,o.w,o.h);

     // ハンドル
     ctx.fillRect(o.x+o.w/2-5,o.y+o.h/2-5,10,10);
   }

   // 椅子
   if(o.type==="chair"){
     ctx.beginPath();
     ctx.arc(o.x,o.y,25,0,Math.PI*2);
     ctx.stroke();

     const inst=objects.find(i=>i.linkedChairId===o.id);
     if(inst){
       ctx.fillText(inst.name,o.x,o.y+4);
     }
   }

   // 譜面台
   if(o.type==="stand"){
     ctx.beginPath();
     ctx.moveTo(o.x,o.y-20);
     ctx.lineTo(o.x,o.y+20);
     ctx.moveTo(o.x-20,o.y-20);
     ctx.lineTo(o.x+20,o.y-20);
     ctx.stroke();
   }

   // 楽器（リンク中非表示）
   if(o.type==="instrument"){
     if(o.linkedChairId)return;
     ctx.strokeRect(o.x-25,o.y-25,50,50);
     ctx.fillText(o.name,o.x,o.y+4);
   }

   // スポットライト
   if(o.type==="light"){
     ctx.beginPath();
     ctx.fillStyle="rgba(255,255,0,0.3)";
     ctx.arc(o.x,o.y,o.radius,0,Math.PI*2);
     ctx.fill();

     ctx.strokeStyle="#000";
     ctx.beginPath();
     ctx.arc(o.x,o.y,o.radius,0,Math.PI*2);
     ctx.stroke();

     ctx.fillStyle="#000";
   }

 });

 requestAnimationFrame(draw);
}
draw();

let pinchStartDist = null;

canvas.addEventListener("pointermove", e=>{
  if(e.pointerType !== "touch") return;
});

 canvas.addEventListener("touchmove", e=>{

  if(e.touches.length===2 && selected){

    const dx =
      e.touches[0].clientX -
      e.touches[1].clientX;

    const dy =
      e.touches[0].clientY -
      e.touches[1].clientY;

    const dist = Math.hypot(dx,dy);

    if(!pinchStartDist){
      pinchStartDist = dist;
      return;
    }

    const scale = dist / pinchStartDist;

    if(selected.type==="step"){
      selected.w *= scale;
      selected.h *= scale;
    }

    if(selected.type==="light"){
      selected.radius *= scale;
    }

    pinchStartDist = dist;
  }

},{passive:false});

canvas.addEventListener("touchend",()=>{
  pinchStartDist=null;
});
ctx.arc(o.x,o.y,30,0,Math.PI*2);
ctx.strokeRect(o.x-30,o.y-30,60,60);
let lastTap = 0;

canvas.addEventListener("pointerdown",e=>{

  const now = Date.now();
  if(now - lastTap < 300){

    const r=canvas.getBoundingClientRect();
    const x=e.clientX-r.left;
    const y=e.clientY-r.top;

    objects = objects.filter(o=>
      !(Math.abs(o.x-x)<40 && Math.abs(o.y-y)<40)
    );
  }
  lastTap = now;
});
</script>
</body>
</html>
