<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>吹奏楽配置アプリ</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body{
  margin:0;
  display:flex;
  font-family:sans-serif;
}

#palette{
  width:230px;
  background:#222;
  color:white;
  padding:10px;
}

.item{
  background:#444;
  margin:8px 0;
  padding:10px;
  text-align:center;
  cursor:grab;
  border-radius:6px;
}

#stageWrapper{
  flex:1;
  padding:10px;
}

canvas{
  border:2px solid #999;
  background:white;
}
</style>
</head>

<body>

<div id="palette">
<h3>ドラッグ配置</h3>

<div class="item" draggable="true" data-type="chair">椅子</div>
<div class="item" draggable="true" data-type="stand">譜面台</div>
<div class="item" draggable="true" data-type="step">段差</div>
<div class="item" draggable="true" data-type="instrument">楽器</div>

<input id="instName" placeholder="楽器名">
</div>

<div id="stageWrapper">
<canvas id="c" width="1000" height="650"></canvas>
</div>

<script>
const canvas=new fabric.Canvas('c');
const wrapper=document.getElementById("stageWrapper");

/* =====================
   Drag情報
===================== */

let dragType=null;

document.querySelectorAll(".item").forEach(el=>{
  el.addEventListener("dragstart",e=>{
    dragType=el.dataset.type;
  });
});

/* =====================
   Drop（完全修正版）
===================== */

wrapper.addEventListener("dragover",e=>e.preventDefault());

wrapper.addEventListener("drop",e=>{
  e.preventDefault();

  const rect=canvas.upperCanvasEl.getBoundingClientRect();

  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;

  createObject(dragType,x,y);
});

/* =====================
   椅子（○）
===================== */

function createChair(x,y){

  const circle=new fabric.Circle({
    radius:18,
    fill:"#ffffff",
    stroke:"#000",
    strokeWidth:2,
    originX:"center",
    originY:"center"
  });

  const label=new fabric.Text("",{
    fontSize:12,
    originX:"center",
    originY:"center"
  });

  const group=new fabric.Group([circle,label],{
    left:x,
    top:y
  });

  group.typeTag="chair";
  group.label=label;

  canvas.add(group);
}

/* =====================
   譜面台（T字）
===================== */

function createStand(x,y){

  const top=new fabric.Rect({
    width:30,height:6,fill:"#000",top:-12
  });

  const pole=new fabric.Rect({
    width:4,height:30,fill:"#000"
  });

  const stand=new fabric.Group([top,pole],{
    left:x,
    top:y
  });

  stand.typeTag="stand";
  canvas.add(stand);
}

/* =====================
   段差
===================== */

let stepNo=1;

function createStep(x,y){

  const top=new fabric.Rect({
    width:160,height:60,fill:"#d0d0d0"
  });

  const side=new fabric.Rect({
    width:160,height:15,fill:"#999",top:60
  });

  const text=new fabric.Text("STEP "+stepNo,{
    fontSize:14,
    left:40,
    top:20
  });

  const g=new fabric.Group([top,side,text],{
    left:x,
    top:y
  });

  g.typeTag="step";
  stepNo++;

  canvas.add(g);
  g.sendToBack();
}

/* =====================
   楽器
===================== */

function createInstrument(x,y){

  const name=document.getElementById("instName").value||"Inst";

  const text=new fabric.Text(name,{
    fontSize:16,
    left:x,
    top:y
  });

  text.typeTag="instrument";
  text.instrumentName=name;

  canvas.add(text);
}

/* =====================
   生成分岐
===================== */

function createObject(type,x,y){

  if(type==="chair") createChair(x,y);
  if(type==="stand") createStand(x,y);
  if(type==="step") createStep(x,y);
  if(type==="instrument") createInstrument(x,y);
}

/* =====================
   椅子リンク
===================== */

canvas.on("object:moving",e=>{

  const obj=e.target;
  if(obj.typeTag!=="instrument") return;

  let linked=null;

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair"){

      const dx=o.left-obj.left;
      const dy=o.top-obj.top;
      const dist=Math.sqrt(dx*dx+dy*dy);

      if(dist<30) linked=o;
    }
  });

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair"){
      o.label.text="";
    }
  });

  if(linked){
    linked.label.text=obj.instrumentName;
  }

  canvas.requestRenderAll();
});

/* =====================
   Delete削除
===================== */

document.addEventListener("keydown",e=>{
  if(e.key==="Delete"){
    const obj=canvas.getActiveObject();
    if(obj) canvas.remove(obj);
  }
});
</script>

</body>
</html>
