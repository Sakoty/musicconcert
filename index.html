<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>吹奏楽 舞台配置エディタ</title>

<style>
body{
  margin:0;
  font-family:sans-serif;
  display:flex;
  height:100vh;
}

#toolbar{
  width:220px;
  background:#f0f0f0;
  padding:10px;
  border-right:2px solid #ccc;
}

button{
  width:100%;
  margin:4px 0;
  padding:8px;
}

canvas{
  background:white;
  flex:1;
  cursor:grab;
}
</style>
</head>

<body>

<div id="toolbar">
<h3>追加</h3>
<button onclick="addItem('stand')">譜面台</button>
<button onclick="addItem('chair')">椅子</button>
<button onclick="addInstrument()">楽器</button>
<button onclick="addItem('step')">段差</button>

<hr>
<button onclick="toggleView()">指揮者視点</button>
</div>

<canvas id="stage"></canvas>

<script>
const canvas = document.getElementById("stage");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth - 220;
  canvas.height = window.innerHeight;
}
resize();
window.onresize = resize;

let conductorView=false;

const items=[];
let dragging=null;
let offsetX=0, offsetY=0;

function addItem(type){
  items.push({
    type,
    x:150,
    y:150,
    w:80,
    h:40,
    linkedInstrument:null
  });
  draw();
}

function addInstrument(){
  const name = prompt("楽器名を入力");
  if(!name) return;

  items.push({
    type:"instrument",
    name,
    x:200,
    y:200,
    w:90,
    h:40
  });
  draw();
}

function toggleView(){
  conductorView=!conductorView;
  draw();
}

/* =====================
   描画（黒固定）
===================== */
function draw(){

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();

  if(conductorView){
    ctx.translate(canvas.width,0);
    ctx.scale(-1,1);
  }

  ctx.lineWidth=2;
  ctx.strokeStyle="black";
  ctx.fillStyle="black";
  ctx.font="14px sans-serif";
  ctx.textAlign="center";

  items.forEach(obj=>{

    /* 段差 */
    if(obj.type==="step"){
      ctx.strokeRect(obj.x,obj.y,obj.w,obj.h);
      ctx.fillText("段",obj.x+obj.w/2,obj.y+25);
    }

    /* 譜面台（T字） */
    if(obj.type==="stand"){
      ctx.beginPath();
      ctx.moveTo(obj.x+40,obj.y);
      ctx.lineTo(obj.x+40,obj.y+40);
      ctx.moveTo(obj.x+20,obj.y);
      ctx.lineTo(obj.x+60,obj.y);
      ctx.stroke();
    }

    /* 椅子（○） */
    if(obj.type==="chair"){
      ctx.beginPath();
      ctx.arc(obj.x+20,obj.y+20,20,0,Math.PI*2);
      ctx.stroke();

      if(obj.linkedInstrument){
        ctx.fillText(
          obj.linkedInstrument,
          obj.x+20,
          obj.y+25
        );
      }
    }

    /* 楽器 */
    if(obj.type==="instrument"){
      ctx.strokeRect(obj.x,obj.y,obj.w,obj.h);
      ctx.fillText(obj.name,obj.x+obj.w/2,obj.y+25);
    }

  });

  ctx.restore();
}

/* =====================
   ドラッグ処理（修正版）
===================== */

canvas.addEventListener("mousedown",e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left;
  const my=e.clientY-rect.top;

  for(let i=items.length-1;i>=0;i--){
    const o=items[i];

    if(mx>o.x && mx<o.x+o.w &&
       my>o.y && my<o.y+o.h){

      dragging=o;
      offsetX=mx-o.x;
      offsetY=my-o.y;
      canvas.style.cursor="grabbing";
      return;
    }
  }
});

canvas.addEventListener("mousemove",e=>{
  if(!dragging) return;

  const rect=canvas.getBoundingClientRect();
  dragging.x=e.clientX-rect.left-offsetX;
  dragging.y=e.clientY-rect.top-offsetY;

  checkLink();
  draw();   // ← 毎回再描画（重要修正）
});

canvas.addEventListener("mouseup",()=>{
  dragging=null;
  canvas.style.cursor="grab";
});

canvas.addEventListener("mouseleave",()=>{
  dragging=null;
});

/* =====================
   椅子と楽器リンク
===================== */
function checkLink(){

  const chairs=items.filter(i=>i.type==="chair");
  const instruments=items.filter(i=>i.type==="instrument");

  chairs.forEach(c=>{
    c.linkedInstrument=null;

    instruments.forEach(inst=>{
      if(
        inst.x < c.x+40 &&
        inst.x+inst.w > c.x &&
        inst.y < c.y+40 &&
        inst.y+inst.h > c.y
      ){
        c.linkedInstrument=inst.name;
      }
    });
  });
}

draw();
</script>

</body>
</html>
