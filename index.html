<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å¹å¥æ¥½ã‚¹ãƒ†ãƒ¼ã‚¸é…ç½®</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body{
  margin:0;
  display:flex;
  font-family:sans-serif;
  background:#f0f2f5;
}

#palette{
  width:240px;
  background:#222;
  color:white;
  padding:10px;
}

.paletteItem{
  background:#444;
  margin:8px 0;
  padding:12px;
  text-align:center;
  border-radius:6px;
  cursor:grab;
}

#stageArea{
  flex:1;
  padding:10px;
}

canvas{
  background:white;
  border:2px solid #999;
}

input,button{
  width:100%;
  margin-top:6px;
  padding:6px;
}
</style>
</head>

<body>

<div id="palette">
  <h3>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é…ç½®</h3>
  <div id="items"></div>

  <hr>

  <input id="instName" placeholder="æ¥½å™¨å">
  <button onclick="addNewInstrument()">æ¥½å™¨è¿½åŠ </button>
</div>

<div id="stageArea">
  <canvas id="c" width="1000" height="650"></canvas>
</div>

<script>
const canvas=new fabric.Canvas('c');

const itemsDiv=document.getElementById("items");

/* ======================
   ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆ
====================== */

function createPaletteItem(name,type,icon){
  const div=document.createElement("div");
  div.className="paletteItem";
  div.textContent=icon+" "+name;
  div.draggable=true;

  div.addEventListener("dragstart",e=>{
    e.dataTransfer.setData("type",type);
    e.dataTransfer.setData("icon",icon);
  });

  itemsDiv.appendChild(div);
}

/* åˆæœŸ */
createPaletteItem("æ¤…å­","chair","ğŸª‘");
createPaletteItem("è­œé¢å°","stand","ğŸ¼");
createPaletteItem("æ®µå·®ãƒ–ãƒ­ãƒƒã‚¯","step","â¬›");
createPaletteItem("ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ","instrument","ğŸº");
createPaletteItem("ã‚µãƒƒã‚¯ã‚¹","instrument","ğŸ·");

/* ======================
   æ¥½å™¨è¿½åŠ 
====================== */

function addNewInstrument(){
  const name=document.getElementById("instName").value.trim();
  if(!name) return;

  createPaletteItem(name,"instrument","ğŸµ");
  document.getElementById("instName").value="";
}

/* ======================
   Dropå‡¦ç†
====================== */

const canvasEl=canvas.upperCanvasEl;

canvasEl.addEventListener("dragover",e=>e.preventDefault());

canvasEl.addEventListener("drop",e=>{
  e.preventDefault();

  const type=e.dataTransfer.getData("type");
  const icon=e.dataTransfer.getData("icon");

  const p=canvas.getPointer(e);
  createObject(type,icon,p.x,p.y);
});

/* ======================
   æ®µå·®ç”Ÿæˆï¼ˆNEWï¼‰
====================== */

let stepCount=1;

function createStep(x,y){

  const top=new fabric.Rect({
    width:160,
    height:60,
    fill:"#cfcfcf",
    originY:"center"
  });

  const side=new fabric.Rect({
    width:160,
    height:18,
    fill:"#9a9a9a",
    top:30,
    originY:"center"
  });

  const label=new fabric.Text(
    "STEP "+stepCount,{
      fontSize:14,
      top:-18,
      fill:"#333",
      originX:"center"
    });

  const group=new fabric.Group(
    [top,side,label],
    {left:x,top:y}
  );

  group.typeTag="step";
  group.stepLevel=stepCount;

  stepCount++;

  canvas.add(group);
  group.sendToBack(); // åºŠæ‰±ã„
}

/* ======================
   ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
====================== */

function createObject(type,icon,x,y){

  if(type==="step"){
    createStep(x,y);
    return;
  }

  if(type==="chair"){
    const chair=new fabric.Rect({
      left:x,top:y,width:35,height:35,
      fill:"#8b5a2b",rx:5,ry:5
    });
    chair.typeTag="chair";
    canvas.add(chair);
  }

  if(type==="stand"){
    const stand=new fabric.Group([
      new fabric.Rect({width:30,height:20,fill:"#333",top:-10}),
      new fabric.Rect({width:4,height:40,fill:"#333",top:10})
    ],{left:x,top:y});
    stand.typeTag="stand";
    canvas.add(stand);
  }

  if(type==="instrument"){
    const inst=new fabric.Text(icon,{
      left:x,top:y,fontSize:30
    });
    inst.typeTag="instrument";
    inst.linkedChair=null;
    canvas.add(inst);
  }
}

/* ======================
   æ¤…å­ãƒªãƒ³ã‚¯
====================== */

canvas.on("object:moving",e=>{
  const obj=e.target;
  if(obj.typeTag!=="instrument") return;

  let linked=null;

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair"){
      const dx=o.left-obj.left;
      const dy=o.top-obj.top;
      if(Math.sqrt(dx*dx+dy*dy)<40) linked=o;
    }
  });

  canvas.getObjects().forEach(o=>{
    if(o.typeTag==="chair")
      o.set("fill","#8b5a2b");
  });

  if(linked){
    linked.set("fill","#2ecc71");
    obj.linkedChair=linked;
  }

  canvas.renderAll();
});

/* ======================
   Deleteå‰Šé™¤
====================== */

document.addEventListener("keydown",e=>{
  if(e.key==="Delete"){
    const obj=canvas.getActiveObject();
    if(obj) canvas.remove(obj);
  }
});
</script>

</body>
</html>
