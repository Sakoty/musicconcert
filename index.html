<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>舞台配置エディタ</title>

<style>
body{
  margin:0;
  display:flex;
  height:100vh;
  font-family:sans-serif;
}

#toolbar{
  width:240px;
  background:#f2f2f2;
  padding:10px;
  border-right:2px solid #ccc;
}

.paletteItem{
  background:white;
  border:1px solid #999;
  padding:6px;
  margin:4px 0;
  cursor:grab;
}

canvas{
  flex:1;
  background:white;
}
</style>
</head>

<body>

<div id="toolbar">
<h3>パレット</h3>

<div class="paletteItem" draggable="true" data-type="chair">椅子</div>
<div class="paletteItem" draggable="true" data-type="stand">譜面台</div>
<div class="paletteItem" draggable="true" data-type="step">段</div>

<button onclick="addInstrument()">楽器追加</button>
<div id="instrumentPalette"></div>
</div>

<canvas id="stage"></canvas>

<script>
const canvas=document.getElementById("stage");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=window.innerWidth-240;
  canvas.height=window.innerHeight;
}
resize();
window.onresize=resize;

const items=[];
const instrumentPalette=[];
let selectedItems=[];

let dragging=false;
let resizing=null;

let dragStartX=0;
let dragStartY=0;

/* =====================
   パレットD&D
===================== */

document.querySelectorAll(".paletteItem").forEach(el=>{
  el.addEventListener("dragstart",e=>{
    e.dataTransfer.setData("type",el.dataset.type);
  });
});

canvas.addEventListener("dragover",e=>e.preventDefault());

canvas.addEventListener("drop",e=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect();

  const type=e.dataTransfer.getData("type");
  const name=e.dataTransfer.getData("instrument");

  if(type){
    createItem(type,
      e.clientX-rect.left,
      e.clientY-rect.top);
  }

  if(name){
    items.push({
      type:"instrument",
      name,
      x:e.clientX-rect.left,
      y:e.clientY-rect.top,
      w:100,
      h:40,
      hidden:false
    });
  }

  draw();
});

/* =====================
   生成
===================== */

function createItem(type,x,y){
  items.push({
    type,
    x,y,
    w:120,
    h:60,
    linkedInstrument:null,
    hidden:false,
    resizable:(type==="step")
  });
}

function addInstrument(){
  const name=prompt("楽器名");
  if(!name)return;

  if(!instrumentPalette.includes(name)){
    instrumentPalette.push(name);
    refreshPalette();
  }
}

function refreshPalette(){
  const div=document.getElementById("instrumentPalette");
  div.innerHTML="";

  instrumentPalette.forEach(name=>{
    const el=document.createElement("div");
    el.className="paletteItem";
    el.textContent=name;
    el.draggable=true;

    el.addEventListener("dragstart",e=>{
      e.dataTransfer.setData("instrument",name);
    });

    div.appendChild(el);
  });
}

/* =====================
   マウス操作
===================== */

canvas.addEventListener("mousedown",e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left;
  const my=e.clientY-rect.top;

  let clicked=null;

  for(let i=items.length-1;i>=0;i--){
    const o=items[i];
    if(o.hidden) continue;

    /* リサイズ判定 */
    if(o.resizable){
      if(mx>o.x+o.w-10 &&
         mx<o.x+o.w &&
         my>o.y+o.h-10 &&
         my<o.y+o.h){
           resizing=o;
           return;
      }
    }

    if(mx>o.x && mx<o.x+o.w &&
       my>o.y && my<o.y+o.h){
      clicked=o;
      break;
    }
  }

  if(!clicked){
    selectedItems=[];
    draw();
    return;
  }

  if(e.shiftKey){
    if(!selectedItems.includes(clicked))
      selectedItems.push(clicked);
  }else{
    selectedItems=[clicked];
  }

  dragging=true;
  dragStartX=mx;
  dragStartY=my;

  draw();
});

/* ===== 移動 or サイズ変更 ===== */

canvas.addEventListener("mousemove",e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left;
  const my=e.clientY-rect.top;

  if(resizing){
    resizing.w=Math.max(40,mx-resizing.x);
    resizing.h=Math.max(20,my-resizing.y);
    draw();
    return;
  }

  if(!dragging)return;

  const dx=mx-dragStartX;
  const dy=my-dragStartY;

  selectedItems.forEach(o=>{
    o.x+=dx;
    o.y+=dy;
  });

  dragStartX=mx;
  dragStartY=my;

  checkLink();
  draw();
});

canvas.addEventListener("mouseup",()=>{
  dragging=false;
  resizing=null;
});

canvas.addEventListener("mouseleave",()=>{
  dragging=false;
  resizing=null;
});

/* =====================
   ダブルクリック削除
===================== */

canvas.addEventListener("dblclick",()=>{

  if(selectedItems.length===0) return;

  selectedItems.forEach(sel=>{
    const index=items.indexOf(sel);
    if(index>-1) items.splice(index,1);
  });

  selectedItems=[];
  draw();
});

/* =====================
   椅子リンク
===================== */

function checkLink(){
  const chairs=items.filter(i=>i.type==="chair");
  const instruments=items.filter(i=>i.type==="instrument");

  instruments.forEach(i=>i.hidden=false);

  chairs.forEach(c=>{
    c.linkedInstrument=null;

    instruments.forEach(inst=>{
      if(
        inst.x < c.x+40 &&
        inst.x+inst.w > c.x &&
        inst.y < c.y+40 &&
        inst.y+inst.h > c.y
      ){
        c.linkedInstrument=inst.name;
        inst.hidden=true;
      }
    });
  });
}

/* =====================
   描画
===================== */

function draw(){

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.lineWidth=2;
  ctx.strokeStyle="black";
  ctx.fillStyle="black";
  ctx.font="14px sans-serif";
  ctx.textAlign="center";

  items.forEach(o=>{
    if(o.hidden)return;

    if(o.type==="chair"){
      ctx.beginPath();
      ctx.arc(o.x+20,o.y+20,20,0,Math.PI*2);
      ctx.stroke();
      if(o.linkedInstrument)
        ctx.fillText(o.linkedInstrument,o.x+20,o.y+25);
    }

    if(o.type==="stand"){
      ctx.beginPath();
      ctx.moveTo(o.x+40,o.y);
      ctx.lineTo(o.x+40,o.y+40);
      ctx.moveTo(o.x+20,o.y);
      ctx.lineTo(o.x+60,o.y);
      ctx.stroke();
    }

    if(o.type==="step"){
      ctx.strokeRect(o.x,o.y,o.w,o.h);
      ctx.fillText("段",o.x+o.w/2,o.y+25);

      /* サイズ変更ハンドル */
      ctx.fillRect(o.x+o.w-8,o.y+o.h-8,8,8);
    }

    if(o.type==="instrument"){
      ctx.strokeRect(o.x,o.y,o.w,o.h);
      ctx.fillText(o.name,o.x+o.w/2,o.y+25);
    }

    /* 選択枠 */
    if(selectedItems.includes(o)){
      ctx.strokeStyle="blue";
      ctx.strokeRect(o.x-4,o.y-4,o.w+8,o.h+8);
      ctx.strokeStyle="black";
    }
  });
}

draw();
</script>
</body>
</html>
